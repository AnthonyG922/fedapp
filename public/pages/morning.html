<html>
  <head>
    <!-- JS dependencies -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/4.6.2/firebase.js"></script>
    <script src="https://www.gstatic.com/firebasejs/4.6.2/firebase-firestore.js"></script>
    <script src="../js/bootstrap.min.js"></script>
    <script src="../js/fire.js"></script>
    <!-- CSS scripts -->
    <link href="../css/bootstrap.css" rel="stylesheet">
    <!-- Start of Google Analytics code -->
    <script type="text/javascript">

        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-109545305-1']);
        _gaq.push(['_trackPageview']);

        (function() {
          var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
          ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
          var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();
    </script>
    <!-- End of Google Analytics code -->
  </head>
  <body>
    <nav class="navbar navbar-inverse navbar-fixed-top ">
      <div class="container">
        <div class="navbar-header">
          <a class="navbar-brand" href="#">Fed Day leaderboard</a>
        </div>
        <ul class="nav navbar-nav">
          <li><a href="../index.html">Home</a></li>
          <li class="active"><a href="#">Morning Projects</a></li>
          <li><a href="afternoon.html">Afternoon Projects</a></li>
        </ul>
      </div>
    </nav>
    <div class="container" style="margin-top:60px;">
      <div class="row">
        <div class="col-lg-3" id="projects">
          <!-- left div contains the list of all morning projects -->
          <ul id="morning_projects" class="list-group"></ul>
        </div>
        <div class="col-lg-9" id="morning_project_details">
          <!-- right div contains the teams within the highlighted morning project -->
        </div>
      </div>
    </div>
  </body>
  <script>
    $(document).ready(function(){
      // Get all the data and populate the page

      // Initialize the firestore config
      var masterDB = fire.firestore();

      // Get all the projects
      var projectsCollection = masterDB.collection("Projects");

      // Data objects to help update view periodically
      var prjTeamDisplayIdx = 0;
      var prjTeamDisplayIds = [];

      var currPrjId;
      var currPrjListId;

      var prevPrjId;
      var prevPrjListId;

      // Get the projects under the 'projects collection'
      projectsCollection.get().then(function(allPrjQrySnpSht) {

        // For each project get the teams that are participating in morning
        allPrjQrySnpSht.forEach(function(projectDocSnpSht) {

            // This actually gets the morning teams for a particular project type
            var morningTeamCollection = masterDB.collection("Projects/" + projectDocSnpSht.id +"/Morning");

            // Convert the project id to snakecase eg: 3D Printing => 3d_printing
            var prjId = projectDocSnpSht.id.toLowerCase().replace(' ','_');

            // Append a list item for each project on the left hand side of page
            $("#morning_projects").append("<li class='list-group-item' id='" + prjId + "'>" + projectDocSnpSht.id + "</li>");

            // Add panel to display all teams under the current project being referenced in the loop
            $("#morning_project_details").append("<div id='panel_" + prjId + "' class='panel panel-primary'>" +
              "<div class='panel-heading'><h3 class='panel-title'>" + projectDocSnpSht.id + "</h3></div>" +
              "<div id='panel_" + prjId + "_body' class='panel-body'></div></div>");

            // Hide the teams and only show score of one project at a time
            $("#panel_" + prjId).hide();

            // Create an list to show all the teams under the current project being referenced in the loop
            $("#panel_" + prjId + "_body").append("<ul id='project_"+ prjId +"_list' ></ul>");

            // Add the project 'div' ids to the array, used to update view
            prjTeamDisplayIds.push(prjId);

            // Added listener on individual morning project
            morningTeamCollection.onSnapshot({includeDocumentMetadataChanges: true}, function(mrnTmQrySnpSht){

              // Get all the teams within the current project
              mrnTmQrySnpSht.forEach(function(teamDoc) {

                // Convert the team id to snakecase
                var teamId = teamDoc.id.toLowerCase().replace(' ','_');

                // In case of an update to the team score, check if it is already rendered on page
                // If yes, remove the list item so that the newly updates score is shown
                if($("#"+prjId+"_"+teamId).get(0)){
                  $("#"+prjId+"_"+teamId).remove();
                }

                // Create a new team list item to show the score
                $("#project_"+ prjId +"_list").append("<li class='list-group-item' id='" + prjId+"_"+teamId + "'>" + teamDoc.id + " | " + teamDoc.data().Total + "</li>");
              })
            })
        });
      });

      // Method to update the view periodically
      function updateView(){

        // Get the current project
        currPrjId = prjTeamDisplayIds[prjTeamDisplayIdx];
        currPrjListId = "#panel_"+ currPrjId;

        console.log(currPrjListId);

        if(prevPrjId != null) {
          // Hide the teams for other project
          $(prevPrjListId).hide();
          // Remove higlighting
          $("#"+prevPrjId).removeClass('active');
        }

        if(currPrjId != null){
          // Show the teams for current project
          $(currPrjListId).show();
          // Highlight the left navigation
          $("#"+currPrjId).addClass('active');
        }

        // Update cyclic counter
        prjTeamDisplayIdx = (prjTeamDisplayIdx + 1)%prjTeamDisplayIds.length;

        // Update prev references
        prevPrjId = currPrjId;
        prevPrjListId = currPrjListId;
      }

      // This does not poll data, this just changes the views to show score by each project
      setInterval(function(){
        // Call the update view method every 10 seconds
        updateView();
      }, 10000);
    });

  </script>
</html>
